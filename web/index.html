<!-- web/index.html -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>AI Shopping Assistant — Minimal Frontend</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
        body { margin: 24px; background: #fafafa; color: #111; }
        h1 { margin: 0 0 16px; font-size: 22px; }
        .card { background: #fff; padding: 16px; border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,.06); max-width: 980px; margin: 0 auto; }
        .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
        label { font-size: 13px; color: #555; }
        input[type="text"], input[type="number"] { padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; min-width: 260px; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124,58,237,.18); }
        .btn { padding: 10px 16px; border-radius: 10px; border: 0; background: #7c3aed; color: #fff; cursor: pointer; }
        .btn:disabled { opacity: .6; cursor: not-allowed; }
        .muted { color: #666; font-size: 12px; }
        .switch { display: inline-flex; align-items: center; gap: 6px; user-select: none; }
        .sep { height: 1px; background: #eee; margin: 16px 0; }
        .pill { background: #eef; color: #334; border-radius: 999px; padding: 4px 10px; font-size: 12px; display: inline-block; margin-right: 6px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
        .card-item { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px; }
        .error { background: #ffefef; color: #a40000; padding: 10px; border-radius: 10px; }
        pre { background: #0b1020; color: #d6e0ff; padding: 16px; border-radius: 12px; overflow: auto; max-height: 480px; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 820px) { .two-col { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<h1>AI Shopping Assistant — Minimal Frontend</h1>
<div class="card">
    <div class="row">
        <div>
            <label>API base URL</label><br />
            <input id="api" type="text" />
            <div class="muted">Defaults to current site. Change if your API runs elsewhere.</div>
        </div>
        <div>
            <label>Top N</label><br />
            <input id="topn" type="number" value="8" min="1" max="50" />
        </div>
        <div>
            <label>Style threshold</label><br />
            <input id="sth" type="number" step="0.1" min="0" max="1" value="0.7" />
        </div>
        <div class="switch">
            <input id="useLLM" type="checkbox" />
            <label for="useLLM">Use LLM</label>
        </div>
    </div>

    <div class="sep"></div>

    <label>Query</label><br />
    <input id="q" type="text" placeholder="e.g. sporty jacket under $100" style="width:100%" />

    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap: wrap;">
        <button class="btn" id="run">Search</button>
        <button class="btn" id="rec">Recommend Only</button>
        <button class="btn" id="reload">Reload Catalog</button>
        <a class="muted" href="/docs" target="_blank" rel="noreferrer">/docs</a>
        <span id="status" class="muted" style="margin-left:auto;"></span>
    </div>

    <div class="sep"></div>

    <div id="noti"></div>

    <div class="two-col">
        <div>
            <div id="summary"></div>
            <div id="candidates" class="muted" style="margin:8px 0;"></div>
            <div id="products" class="grid"></div>
        </div>
        <div>
            <label>Texts</label>
            <div id="texts" class="card-item">
                <div id="rb" class="muted">Rule-based copy will appear here.</div>
                <div class="sep"></div>
                <div id="llm" class="muted">LLM copy will appear here (if enabled).</div>
            </div>

            <div class="sep"></div>

            <label>Raw response</label>
            <pre id="raw">Click “Search” to see JSON here.</pre>
        </div>
    </div>
</div>

<script>
    const $ = (id) => document.getElementById(id);
    const btn = $('run');
    const btnRec = $('rec');
    const btnReload = $('reload');
    const status = $('status');
    const sum = $('summary');
    const grid = $('products');
    const raw = $('raw');
    const noti = $('noti');
    const rb = $('rb');
    const llm = $('llm');
    const candidatesDiv = $('candidates');

    // init API base (remember last used)
    (function initBase() {
        const saved = localStorage.getItem('api_base');
        const def = window.location.origin;
        $('api').value = saved || def;
        $('api').addEventListener('change', () => {
            localStorage.setItem('api_base', $('api').value.replace(/\/+$/, ''));
        });
    })();

    // enter to search
    $('q').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') btn.click();
    });

    function setBusy(b, msg='Working…') {
        btn.disabled = btnRec.disabled = btnReload.disabled = b;
        status.textContent = b ? msg : '';
    }

    function toast(msg, type='error') {
        noti.innerHTML = `<div class="${type==='error' ? 'error' : ''}">${msg}</div>`;
        setTimeout(() => noti.innerHTML = '', 3000);
    }

    function productCard(p) {
        const div = document.createElement('div');
        div.className = 'card-item';
        div.innerHTML = `
      <div style="font-weight:600">${p.name}</div>
      <div class="muted">${p.category} • ${p.style}</div>
      <div style="margin-top:6px;">$${Number(p.price).toFixed(2)}</div>
    `;
        return div;
    }

    function render(data) {
        raw.textContent = JSON.stringify(data, null, 2);

        const r = data.result || data; // /query returns {result,...}; /recommend may differ
        // texts
        rb.textContent = data.rule_based || data.message || '(no rule-based text)';
        llm.textContent = data.llm || '(no LLM text)';

        // summary chips
        if (!r || !r.products) {
            sum.innerHTML = '<span class="muted">No products</span>';
            grid.innerHTML = '';
            candidatesDiv.textContent = '';
            return;
        }
        const pills = [];
        if (r.intent !== undefined) pills.push(`<span class="pill">intent: ${r.intent}</span>`);
        if (r.styles && r.styles.length) pills.push(`<span class="pill">styles: ${r.styles.join(', ')}</span>`);
        if (r.min_price != null || r.max_price != null) {
            const a = r.min_price != null ? `$${Math.round(r.min_price)}` : '';
            const b = r.max_price != null ? `$${Math.round(r.max_price)}` : '';
            pills.push(`<span class="pill">budget: ${a}${a&&b?'~':''}${b}</span>`);
        }
        sum.innerHTML = pills.join(' ') || '<span class="muted">No explicit style/budget</span>';

        // style candidates (phrase, confidence)
        if (r.style_candidates && r.style_candidates.length) {
            const txt = r.style_candidates
                .map(([ph, conf]) => `${ph} (${(conf*100).toFixed(0)}%)`).join(' • ');
            candidatesDiv.textContent = `candidates: ${txt}`;
        } else {
            candidatesDiv.textContent = '';
        }

        // products
        grid.innerHTML = '';
        if (!r.products.length) {
            grid.innerHTML = '<div class="muted">No products found. Try widening your budget or changing keywords.</div>';
            return;
        }
        r.products.forEach(p => grid.appendChild(productCard(p)));
    }

    async function call(endpoint, payload) {
        const base = $('api').value.replace(/\/+$/, '');
        const url = `${base}${endpoint}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        if (!res.ok) {
            // try to read error json
            let detail = '';
            try { const e = await res.json(); detail = e.detail || JSON.stringify(e); } catch {}
            throw new Error(`${res.status} ${res.statusText}${detail ? ' - ' + detail : ''}`);
        }
        return res.json();
    }

    btn.addEventListener('click', async () => {
        const q = $('q').value.trim();
        if (!q) { toast('Please enter a query.'); return; }
        setBusy(true);
        try {
            const data = {
                text: q,
                top_n: Number($('topn').value),
                style_threshold: Number($('sth').value),
                use_llm: $('useLLM').checked
            };
            const out = await call('/query', data);
            render(out);
        } catch (e) {
            toast(String(e));
            raw.textContent = String(e);
        } finally {
            setBusy(false);
        }
    });

    btnRec.addEventListener('click', async () => {
        const q = $('q').value.trim();
        if (!q) { toast('Please enter a query.'); return; }
        setBusy(true);
        try {
            const use_llm = $('useLLM').checked;
            const out = await call('/recommend', { text: q, use_llm });
            render(out);
        } catch (e) {
            toast(String(e));
            raw.textContent = String(e);
        } finally {
            setBusy(false);
        }
    });

    btnReload.addEventListener('click', async () => {
        setBusy(true, 'Reloading catalog…');
        try {
            const out = await call('/reload_catalog', {}); // or { path: "..." }
            raw.textContent = JSON.stringify(out, null, 2);
            toast(`Catalog reloaded: ${out.rows ?? 'OK'}`, 'ok');
        } catch (e) {
            toast(String(e));
            raw.textContent = String(e);
        } finally {
            setBusy(false);
        }
    });
</script>
</body>
</html>
